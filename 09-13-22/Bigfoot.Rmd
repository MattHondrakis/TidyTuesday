---
title: "Bigfoot"
author: "Matthew"
date: "2022-09-13"
output: 
  github_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, dpi = 500)
library(tidyverse)
library(patchwork)
library(scales)
library(tidytext)
theme_set(theme_bw())
```


```{r, include = FALSE}
bigfoot <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-09-13/bigfoot.csv')
```

# EDA
```{r}
skimr::skim(bigfoot)
```


```{r}
bigfoot %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) + geom_histogram() +
  facet_wrap(~key, scales = "free")
```


## Text Analysis
```{r}
bigfoot %>% 
  unnest_tokens(word, summary) %>% 
  anti_join(stop_words) %>%
  group_by(classification) %>% 
  count(word, sort = TRUE) %>% 
  filter(!is.na(word)) %>% 
  head(15) %>% 
  mutate(word = fct_reorder(word, n)) %>% 
  ggplot(aes(n, word)) + geom_col(color = "black", position = position_dodge2(preserve = "single"), aes(fill = classification)) + 
  ggtitle(str_to_title("Most common words describing the day"))
```


```{r}
bigfoot %>% 
  unnest_tokens(word, observed) %>% 
  anti_join(stop_words) %>%
  group_by(classification) %>% 
  count(word, sort = TRUE) %>% 
  filter(!is.na(word)) %>% 
  head(20) %>% 
  ungroup() %>% 
  mutate(word = fct_reorder(word, n, sum)) %>% 
  ggplot(aes(n, word)) + geom_col(color = "black", position = position_dodge2(preserve = "single"), aes(fill = classification)) + 
  ggtitle(str_to_title("Most common words describing the story"))
```


```{r}
bigfoot %>% 
  unnest_tokens(word, title) %>% 
  anti_join(stop_words) %>%
  group_by(classification) %>% 
  count(word, sort = TRUE) %>% 
  filter(!is.na(word)) %>% 
  head(20) %>% 
  ungroup() %>% 
  mutate(word = fct_reorder(word, n, sum)) %>% 
  ggplot(aes(n, word)) + geom_col(color = "black", position = position_dodge2(preserve = "single"), aes(fill = classification)) + 
  ggtitle(str_to_title("Most common words describing the story"))
```


# Model

## Preprocess
```{r}
library(tidymodels)

bigfoot_to_split <- bigfoot %>% 
  filter(classification != "Class C",!is.na(title)) %>%
  mutate(title = str_remove_all(title, ".*\\:")) %>%
  unnest_tokens(title, title) %>% 
  anti_join(stop_words, by = c("title" = "word")) %>% 
  select(class = classification, title) %>% 
  mutate(class = as.factor(class)) %>% 
  filter(fct_lump(title, prop = 0.01) != "Other")



bigfoot_split <- initial_split(bigfoot %>% 
                                  filter(classification != "Class C",!is.na(title)) %>%
                                  mutate(title = str_remove_all(title, ".*\\:")) %>%
                                  unnest_tokens(title, title) %>% 
                                  anti_join(stop_words, by = c("title" = "word")) %>% 
                                  select(class = classification, title) %>% 
                                  mutate(class = as.factor(class)) %>% 
                                  filter(fct_lump(title, prop = 0.01) != "Other"),
                                strata = class)
```


## Fitting
```{r}
glm_workflow <- 
  recipe(formula = class ~ title, data = training(bigfoot_split)) %>% 
  step_novel(all_nominal_predictors()) %>% 
  step_dummy(all_nominal_predictors()) %>% 
  workflow(logistic_reg(mode = "classification", engine = "glm"))


glm_fit <- glm_workflow %>% last_fit(bigfoot_split)
```


## Metrics
```{r}
glm_fit %>% 
  collect_metrics()

glm_fit %>% 
  collect_predictions() %>% 
  roc_curve(as.factor(class), `.pred_Class A`) %>% 
  autoplot()
```

