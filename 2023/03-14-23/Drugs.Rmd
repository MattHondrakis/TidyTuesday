---
title: "European Drug Development"
author: "Matthew"
date: "2023-03-14"
output: 
  github_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, dpi = 500, fig.showtext = TRUE)
library(tidyverse)
library(lubridate)
library(scales)
library(patchwork)
library(sysfonts)
library(showtext)
font_add_google("Roboto Slab", "Roboto")
theme_set(theme_minimal())
theme_update(plot.title = element_text(hjust = 0.5),
             plot.subtitle = element_text(hjust = 0.5),
             text = element_text(family = "Roboto"))
```

```{r, message=FALSE}
drugs <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-03-14/drugs.csv')
```

# EDA

## Categoricals

```{r}
drugs %>% 
  count(category) %>% 
  knitr::kable()

drugs %>% 
  count(authorisation_status, sort = TRUE) %>% 
  knitr::kable()

drugs %>% 
  count(active_substance, sort = TRUE) %>% 
  slice_max(n, n = 5) %>% 
  knitr::kable()
```

## Therapeutic Areas

```{r}
drugs %>% 
  mutate(len = nchar(therapeutic_area)) %>% 
  arrange(-len) %>% 
  head(3) %>% 
  pull(therapeutic_area)
```

As it can be seen, the column *therapeutic_area* contains all possible uses for each drug, separated by **";"**. Thus in order to count how many distinct therapeutic areas a drug is used for, we will need to separate the column into multiple rows based on the delimiter, **";"**.

For example, below we have all the therapeutic areas for the substance *adalimumab*.

```{r}
drugs %>% 
  filter(active_substance == "adalimumab") %>% 
  select(active_substance, therapeutic_area) %>% 
  separate_rows(therapeutic_area, sep = ";  ") %>% 
  distinct(therapeutic_area)
```

```{r}
drugs %>% 
  group_by(active_substance) %>% 
  select(active_substance, therapeutic_area) %>% 
  separate_rows(therapeutic_area, sep = ";  ") %>% 
  distinct(therapeutic_area) %>% 
  summarize(n = n()) %>% 
  arrange(-n) %>% 
  slice_max(n, n = 5) %>% 
  ggplot(aes(n, fct_reorder(active_substance, n))) +
  geom_col(fill = "steelblue4") +
  geom_text(aes(label = n), hjust = 2, color = "white") +
  labs(y = "Active Substance",
       x = "",
       title = "Top 5 Substances by the Number of Therapeutic Applications") +
  theme(plot.title = element_text(hjust = 1))
```

## Authorization Status

```{r}
drugs %>% 
  filter(!is.na(authorisation_status)) %>% 
  ggplot(aes(str_to_title(category), fill = authorisation_status)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("springgreen2", "yellow3", "red3")) +
  labs(title = "Proportion of Drugs Authorization Status by Category",
       y = "Proportion",
       fill = "",
       x = "") +
  scale_y_continuous(labels = percent_format())
```

```{r}
drugs %>% 
  group_by(active_substance) %>% 
  count(authorisation_status, sort = TRUE) %>% 
  filter(authorisation_status == "withdrawn")
```

```{r}
drugs %>% 
  group_by(y = year(first_published)) %>% 
  count(authorisation_status) %>% 
  ggplot(aes(y, n, color = authorisation_status)) +
  geom_line() 

drugs %>% 
  mutate(diff = as.numeric(
    difftime(revision_date, first_published, units = "weeks"))) %>% 
  select(first_published, diff) %>% 
  filter(!is.na(diff)) %>% 
  ggplot(aes(first_published, diff)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Drug Published", 
       y = "Time Until Review (weeks)",
       title = "Time Between Review and Publication over Time")
```
